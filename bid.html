<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘è¦å‡ºåƒ¹ - ç¾å ´ç«¶æ¨™ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; padding: 15px; text-align: center; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 400px; margin: auto; overflow: hidden; }
        
        .info-bar { background: #2c3e50; color: #f1c40f; padding: 20px 10px; border-radius: 15px; margin-bottom: 20px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .info-label { font-size: 18px; color: #ecf0f1; margin-bottom: 5px; }
        .info-price { font-size: 42px; font-weight: 900; text-shadow: 0 0 15px rgba(241, 196, 15, 0.5); animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        input { width: 100%; padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 12px; box-sizing: border-box; margin-bottom: 20px; text-align: center; }
        .b-call { width: 100%; padding: 20px; font-size: 26px; background: #3498db; color: white; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; margin-bottom: 15px; box-shadow: 0 6px #2980b9; transition: 0.2s; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button.b-add { padding: 18px; font-size: 20px; border: none; border-radius: 12px; color: white; cursor: pointer; background: #27ae60; font-weight: bold; box-shadow: 0 4px #219150; transition: 0.2s; }
        .b-quit { background: #95a5a6; grid-column: span 2; margin-top: 15px; padding: 12px; color: white; border: none; border-radius: 10px; }
        .btn-locked { background: #bdc3c7 !important; box-shadow: none !important; opacity: 0.5; pointer-events: none !important; }
        
        #resultOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; flex-direction: column; justify-content: center; align-items: center; color: white; font-weight: bold; padding: 20px; box-sizing: border-box; }
        .win-bg { background: linear-gradient(135deg, #f1c40f, #e67e22); animation: flash 0.5s infinite alternate; }
        .lose-bg { background: linear-gradient(135deg, #2c3e50, #000); }
        .result-title { font-size: 40px; margin-bottom: 10px; }
        .result-price { font-size: 60px; color: #fff; margin: 20px 0; }
        .result-btn { background: white; color: #333; padding: 15px 40px; border-radius: 30px; border: none; font-size: 18px; margin-top: 30px; }
        @keyframes flash { from { opacity: 0.9; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="card" id="mainCard">
    <div class="info-bar">
        <div id="infoLabel" class="info-label">ğŸ† èµ·æ¨™é‡‘é¡</div>
        <div id="infoPrice" class="info-price">$0</div>
    </div>
    <input type="text" id="userName" placeholder="ğŸ‘¤ è«‹è¼¸å…¥æ‚¨çš„å§“å">
    <div id="actions">
        <button id="btn-call" class="b-call btn-bid" onclick="bid(1)">å–Šåƒ¹ (+1)</button>
        <div class="grid">
            <button class="b-add btn-bid" onclick="bid(5)">+$5</button>
            <button class="b-add btn-bid" onclick="bid(10)">+$10</button>
            <button class="b-add btn-bid" onclick="bid(50)">+$50</button>
            <button class="b-add btn-bid" onclick="bid(100)">+$100</button>
            <button id="btn-quit" class="b-quit" onclick="quitBid()">âŒ æ£„æ¨™ / é‡è¨­</button>
        </div>
    </div>
</div>

<div id="resultOverlay">
    <div class="result-title" id="resTitle"></div>
    <div style="font-size: 20px;" id="resSub"></div>
    <div class="result-price" id="resPrice"></div>
    <button class="result-btn" onclick="closeOverlay()">é—œé–‰</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBLKKHyGT1MHJqMq8q8tjJTBNTaIc7EKBs",
        authDomain: "money0115.firebaseapp.com",
        databaseURL: "https://money0115-default-rtdb.firebaseio.com",
        projectId: "money0115",
        storageBucket: "money0115.firebasestorage.app",
        messagingSenderId: "486161681478",
        appId: "1:486161681478:web:ea1107c2c5c8ebe6a5ce47",
        measurementId: "G-WT1BGS47KH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('auction_live');

    let currentStartPrice = 0;
    let bidsList = {};
    let isAuctionClosed = false;

    window.onload = function() {
        const savedName = sessionStorage.getItem('auction_user_name');
        if (savedName) document.getElementById('userName').value = savedName;
    };

    db.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        currentStartPrice = data.startPrice || 0;
        bidsList = data.bids || {};
        const status = data.status || 'open';
        const myName = document.getElementById('userName').value.trim();

        if (status === 'closed') {
            isAuctionClosed = true;
            toggleLock(true);
            showResult(myName, bidsList);
        } else {
            isAuctionClosed = false;
            toggleLock(false);
            document.getElementById('resultOverlay').style.display = 'none';
            updateUI(data);
        }
    });

    function toggleLock(locked) {
        const buttons = document.querySelectorAll('.btn-bid, .b-quit');
        buttons.forEach(btn => {
            if (locked) { btn.classList.add('btn-locked'); btn.disabled = true; } 
            else { btn.classList.remove('btn-locked'); btn.disabled = false; }
        });
    }

    function updateUI(data) {
        const hasAnyBid = Object.keys(bidsList).length > 0;
        const label = document.getElementById('infoLabel');
        const price = document.getElementById('infoPrice');
        
        if (!hasAnyBid) {
            label.innerText = "ğŸ† èµ·æ¨™é‡‘é¡";
            label.style.color = "#ecf0f1";
            price.innerText = "$" + currentStartPrice;
            price.style.color = "#f1c40f";
        } else {
            const maxBid = Math.max(...Object.values(bidsList));
            label.innerText = "ğŸ”¥ ç›®å‰æœ€é«˜åƒ¹";
            label.style.color = "#ff7675";
            price.innerText = "$" + maxBid;
            price.style.color = "#fab1a0";
        }
    }

    function showResult(myName, bids) {
        const overlay = document.getElementById('resultOverlay');
        const sorted = Object.entries(bids).sort((a, b) => b[1] - a[1]);
        const winnerName = sorted.length > 0 ? sorted[0][0] : null;
        const finalPrice = sorted.length > 0 ? sorted[0][1] : 0;
        overlay.style.display = 'flex';
        if (winnerName && myName === winnerName) {
            overlay.className = 'win-bg';
            document.getElementById('resTitle').innerText = "ğŸŠ æ­å–œå¾—æ¨™ï¼";
            document.getElementById('resSub').innerText = "æ‚¨æ˜¯æœ€çµ‚å¾—æ¨™è€…";
            document.getElementById('resPrice').innerText = "$" + finalPrice;
        } else {
            overlay.className = 'lose-bg';
            document.getElementById('resTitle').innerText = "ğŸ”¨ ç«¶æ¨™çµæŸ";
            document.getElementById('resSub').innerText = winnerName ? "å¾—æ¨™è€…ï¼š" + winnerName : "æœ¬æ¬¡æœªæˆäº¤";
            document.getElementById('resPrice').innerText = winnerName ? "æˆäº¤åƒ¹ $" + finalPrice : "";
        }
    }

    function closeOverlay() { document.getElementById('resultOverlay').style.display = 'none'; }

    function bid(amt) {
        if (isAuctionClosed) return;
        const nameInput = document.getElementById('userName');
        const name = nameInput.value.trim();
        if (!name) return alert("è«‹è¼¸å…¥å§“åï¼");
        sessionStorage.setItem('auction_user_name', name);

        db.child('bids').child(name).transaction((curr) => {
            if (isAuctionClosed) return; 
            const hasAnyBid = Object.keys(bidsList).length > 0;
            
            // é—œéµä¿®æ­£ï¼šå¦‚æœæ˜¯ç¬¬ä¸€å€‹æŠ•æ¨™è€…ï¼Œä¸è«–é»æ“Šå¤šå°‘é‡‘é¡ï¼Œå›å‚³èµ·æ¨™åƒ¹
            if (!hasAnyBid) {
                return currentStartPrice;
            } else {
                // å¦‚æœå·²æœ‰å‡ºåƒ¹ï¼Œå‰‡åœ¨æœ€é«˜åƒ¹åŸºç¤ä¸Šç–ŠåŠ 
                const maxBid = Math.max(...Object.values(bidsList));
                const base = (curr || maxBid);
                return base + amt;
            }
        });
    }

    function quitBid() {
        if (isAuctionClosed) return;
        const name = document.getElementById('userName').value.trim();
        if (name && confirm("ç¢ºå®šæ£„æ¨™ï¼Ÿ")) {
            db.child('bids').child(name).remove();
            sessionStorage.removeItem('auction_user_name');
            document.getElementById('userName').value = "";
        }
    }
</script>
</body>
</html>