<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ˆæ¥­ç«¶æ¨™ç³»çµ± - éŸ³æ•ˆèˆ‡èµ·æ¨™ä¿®æ­£ç‰ˆ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: #1a1a1a; color: white; text-align: center; margin: 0; overflow: hidden; }
        .header { padding: 20px; background: #c0392b; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .price-tag { font-size: 110px; color: #f1c40f; margin: 10px 0; font-weight: bold; text-shadow: 0 0 30px rgba(241, 196, 15, 0.8); }
        .winner-announcement { display: none; font-size: 70px; color: #2ecc71; animation: celebrate 0.5s infinite alternate; z-index: 100; position: relative; }
        @keyframes celebrate { from { transform: scale(1); } to { transform: scale(1.1); } }
        .main-layout { display: flex; justify-content: space-around; padding: 20px 40px; }
        #qrcode-container { background: white; padding: 15px; border-radius: 15px; width: 180px; }
        #leaderboard { width: 50%; background: rgba(255,255,255,0.05); border-radius: 20px; padding: 20px; }
        .bid-row { display: flex; justify-content: space-between; font-size: 32px; padding: 12px; border-bottom: 1px solid #333; }
        .rank-1 { background: #f1c40f; color: black; border-radius: 10px; font-weight: bold; }
        .admin-panel { position: fixed; bottom: 0; width: 100%; background: #333; padding: 15px; display: flex; justify-content: center; align-items: center; gap: 15px; border-top: 2px solid #444; }
        input { padding: 10px; font-size: 16px; width: 120px; border-radius: 5px; border: none; text-align: center; font-weight: bold; }
        .admin-btn { padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-mute { background: #7f8c8d; }
        .btn-new { background: #3498db; }
        .btn-end { background: #e74c3c; }
        .is-muted { background: #c0392b !important; text-decoration: line-through; }
    </style>
</head>
<body onclick="initAudio()">

<audio id="bgm" loop preload="auto">
    <source src="https://actions.google.com/éŸ³æ•ˆ/music/electronic_rock.mp3" type="audio/mpeg">
    <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>
<audio id="cheer" preload="auto">
    <source src="https://actions.google.com/éŸ³æ•ˆ/human/cheer_large_crowd.mp3" type="audio/mpeg">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-stadium-crowd-light-applause-482.mp3" type="audio/mpeg">
</audio>

<div class="header"><h1>ç¾å ´å³æ™‚ç«¶æ¨™</h1></div>

<div style="margin-top:10px;">
    <div id="statusText" style="font-size: 24px; color: #bdc3c7;">ç›®å‰æœ€é«˜æ¨™</div>
    <div class="price-tag" id="mainPrice">$0</div>
    <div id="mainUser" style="font-size: 40px; color: #f1c40f;">ç­‰å¾…å‡ºåƒ¹ä¸­...</div>
    <div id="winnerMsg" class="winner-announcement">ğŸŠ æ­å–œå¾—æ¨™ï¼ ğŸŠ</div>
</div>

<div class="main-layout">
    <div id="qrcode-container">
        <div id="qrcode"></div>
        <p style="color: black; margin: 10px 0 5px 0; font-weight: bold; font-size: 14px;">æƒç¢¼åƒèˆ‡ç«¶æ¨™</p>
        <div id="startPriceDisplay" style="color: #c0392b; font-size: 18px; font-weight: bold;">èµ·æ¨™åƒ¹: $0</div>
    </div>
    <div id="leaderboard"><div id="list"></div></div>
</div>

<div class="admin-panel">
    <button id="muteBtn" class="admin-btn btn-mute" onclick="toggleMute()">ğŸ”Š éŸ³æ¨‚é–‹å•Ÿ</button>
    <span>| è¨­å®šèµ·æ¨™åƒ¹ï¼š$</span>
    <input type="number" id="basePriceInput" value="0" placeholder="è«‹è¼¸å…¥é‡‘é¡">
    <button class="admin-btn btn-new" onclick="startNewAuction()">ğŸ”„ é–‹å§‹æ–°ç«¶æ¨™</button>
    <button class="admin-btn btn-end" onclick="finishAuction()">ğŸ”¨ æ±ºæ¨™ (æˆäº¤)</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBLKKHyGT1MHJqMq8q8tjJTBNTaIc7EKBs",
        authDomain: "money0115.firebaseapp.com",
        databaseURL: "https://money0115-default-rtdb.firebaseio.com",
        projectId: "money0115",
        storageBucket: "money0115.firebasestorage.app",
        messagingSenderId: "486161681478",
        appId: "1:486161681478:web:ea1107c2c5c8ebe6a5ce47",
        measurementId: "G-WT1BGS47KH"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref('auction_live');

    let isMuted = false;
    let audioInitialized = false;

    function initAudio() {
        if (audioInitialized) return;
        const bgm = document.getElementById('bgm');
        const cheer = document.getElementById('cheer');
        bgm.play().then(() => { bgm.pause(); cheer.play(); cheer.pause(); audioInitialized = true; })
        .catch(e => console.log("ç­‰å¾…æ‰‹å‹•è§£é–éŸ³æ•ˆ"));
    }

    function toggleMute() {
        isMuted = !isMuted;
        const btn = document.getElementById('muteBtn');
        const bgm = document.getElementById('bgm');
        if (isMuted) {
            btn.innerText = "ğŸ”‡ éŸ³æ¨‚éœéŸ³";
            btn.classList.add('is-muted');
            bgm.pause();
        } else {
            btn.innerText = "ğŸ”Š éŸ³æ¨‚é–‹å•Ÿ";
            btn.classList.remove('is-muted');
            db.child('status').once('value', s => { if(s.val() === 'open') bgm.play(); });
        }
    }

    function launchFireworks() {
        var duration = 5 * 1000;
        var animationEnd = Date.now() + duration;
        var interval = setInterval(function() {
            var timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return clearInterval(interval);
            confetti({ particleCount: 50, spread: 90, origin: { x: 0.1, y: 0.8 }, zIndex: 999 });
            confetti({ particleCount: 50, spread: 90, origin: { x: 0.9, y: 0.8 }, zIndex: 999 });
        }, 300);
    }

    db.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        const bids = data.bids || {};
        const status = data.status || 'open';
        const sorted = Object.entries(bids).sort((a, b) => b[1] - a[1]);

        document.getElementById('startPriceDisplay').innerText = "èµ·æ¨™åƒ¹: $" + (data.startPrice || 0);

        if (status === 'closed') {
            document.getElementById('winnerMsg').style.display = 'block';
            document.getElementById('bgm').pause();
            if (!isMuted && audioInitialized) document.getElementById('cheer').play();
        } else {
            document.getElementById('winnerMsg').style.display = 'none';
        }

        if (sorted.length > 0 && status === 'open') {
            document.getElementById('mainPrice').innerText = "$" + sorted[0][1];
            document.getElementById('mainUser').innerText = sorted[0][0];
            if (!isMuted && audioInitialized) document.getElementById('bgm').play();
        } else if (sorted.length === 0) {
            document.getElementById('mainPrice').innerText = "$0";
            document.getElementById('mainUser').innerText = "ç­‰å¾…å‡ºåƒ¹ä¸­...";
        }

        const listDiv = document.getElementById('list');
        listDiv.innerHTML = sorted.slice(0, 5).map((item, index) => `
            <div class="bid-row ${index === 0 ? 'rank-1' : ''}">
                <span>${index + 1}. ${item[0]}</span>
                <span>$${item[1]}</span>
            </div>
        `).join('');
    });

    const currentUrl = window.location.href.split('?')[0].split('#')[0];
    const phoneUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/')) + "/bid.html";
    new QRCode(document.getElementById("qrcode"), { text: phoneUrl, width: 180, height: 180 });

    function startNewAuction() {
        initAudio(); // æ¯æ¬¡é»æ“Šé–‹å§‹æ™‚å˜—è©¦å†æ¬¡æ¿€æ´»éŸ³æ•ˆ
        const price = parseInt(document.getElementById('basePriceInput').value) || 0;
        if(confirm("ç¢ºå®šé‡å•Ÿç«¶æ¨™ï¼Ÿèµ·æ¨™åƒ¹å°‡è¨­ç‚º $" + price)) {
            db.set({ status: 'open', bids: {}, startPrice: price });
            const bgm = document.getElementById('bgm');
            bgm.currentTime = 0;
            if(!isMuted && audioInitialized) bgm.play();
        }
    }

    function finishAuction() {
        if(confirm("ç¢ºå®šè¦æ±ºæ¨™æˆäº¤å—ï¼Ÿ")) {
            db.child('status').set('closed');
            launchFireworks();
        }
    }
</script>
</body>
</html>